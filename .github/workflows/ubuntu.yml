name: ðŸš€ Low-Latency Ubuntu NoMachine RDP (5-20ms)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  nomachine-desktop:
    runs-on: ubuntu-22.04

    steps:
      - name: ðŸ“¦ Install XFCE Desktop
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies xfce4-terminal firefox dbus-x11 \
            lightdm lightdm-gtk-greeter wget curl gnupg \
            net-tools ufw htop neofetch
          echo "âœ… XFCE installed"

      - name: âš™ï¸ Configure XFCE (Headless Safe)
        run: |
          # Create user config directories
          sudo mkdir -p /home/runner/.config/xfce4/xfconf/xfce-perchannel-xml
          
          # XFCE Desktop (no compositing)
          sudo tee /home/runner/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml > /dev/null << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <channel name="xfce4-desktop" version="1.0">
            <property name="backdrop" type="array">
              <property name="screen0" type="array">
                <property name="monitor0" type="array">
                  <property name="workspace0" type="string" value="/usr/share/backgrounds/xfce/xfce-flower.png"/>
                </property>
              </property>
            </property>
            <property name="show-frame-shadows" type="bool" value="false"/>
            <property name="show-windows-preview" type="bool" value="false"/>
          </channel>
          EOF
          
          # Window Manager (no shadows/animations)
          sudo tee /home/runner/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml > /dev/null << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <channel name="xfwm4" version="1.0">
            <property name="general" type="empty">
              <property name="shadows" type="bool" value="false"/>
              <property name="snap_resist" type="int" value="0"/>
              <property name="show_frame_shadow" type="bool" value="false"/>
            </property>
          </channel>
          EOF
          
          # Theme
          sudo tee /home/runner/.config/xfce4/xfconf/xfce-perchannel-xml/xsettings.xml > /dev/null << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <channel name="xsettings" version="1.0">
            <property name="Net" type="empty">
              <property name="ThemeName" type="string" value="Greybird"/>
              <property name="IconThemeName" type="string" value="Greybird"/>
              <property name="FontName" type="string" value="Sans 10"/>
            </property>
          </channel>
          EOF
          
          # XFCE Session
          sudo tee /home/runner/.xsession > /dev/null << 'EOF'
          #!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          exec /usr/bin/startxfce4
          EOF
          sudo chmod +x /home/runner/.xsession
          
          sudo chown -R runner:runner /home/runner/.config /home/runner/.xsession
          sudo chmod -R 755 /home/runner/.config
          
          echo "âœ… XFCE configured (headless-safe)"

      - name: ðŸ–¥ï¸ Install NoMachine (Latest Stable)
        run: |
          cd /tmp
          
          # Try latest version first
          LATEST_VERSION=$(curl -s https://www.nomachine.com/download | grep -oP 'nomachine_\K[0-9]+\.[0-9]+\.[0-9]+_[0-9]+_amd64\.deb' | head -1)
          
          if [ -z "$LATEST_VERSION" ] || ! wget -q --spider "https://download.nomachine.com/download/${LATEST_VERSION%.*}/Linux/nomachine_${LATEST_VERSION}_amd64.deb"; then
            echo "ðŸ”„ Using stable fallback: 8.11.3_4"
            wget "https://download.nomachine.com/download/8.11/Linux/nomachine_8.11.3_4_amd64.deb"
            sudo dpkg -i nomachine_8.11.3_4_amd64.deb || sudo apt-get install -f -y
          else
            echo "âœ… Downloading latest: $LATEST_VERSION"
            wget "https://download.nomachine.com/download/${LATEST_VERSION%.*}/Linux/nomachine_${LATEST_VERSION}_amd64.deb"
            sudo dpkg -i nomachine_${LATEST_VERSION}_amd64.deb || sudo apt-get install -f -y
          fi
          
          # Performance config (safe)
          if [ -f "/usr/NX/etc/node.cfg" ]; then
            sudo sed -i 's|DefaultDesktopCommand.*|DefaultDesktopCommand "/home/runner/.xsession"|' /usr/NX/etc/node.cfg
            sudo sed -i 's|EnableSSDVirt.*|EnableSSDVirt=true|' /usr/NX/etc/node.cfg
            sudo sed -i 's|SessionTimeout.*|SessionTimeout=7200|' /usr/NX/etc/node.cfg
            sudo sed -i 's|AudioEncoding.*|AudioEncoding=no|' /usr/NX/etc/node.cfg
            echo "âœ… NoMachine config optimized"
          fi
          
          # Start services
          sudo systemctl enable lightdm
          sudo systemctl start lightdm
          sudo /usr/NX/bin/nxserver --startup
          
          echo "âœ… NoMachine ready on port 4000"

      - name: ðŸŒ Install & Connect Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${TAILSCALE_AUTH_KEY} --advertise-tags=tag:github-actions
          sleep 5
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "MAGIC_DNS=$(tailscale status | grep runner | awk '{print $1}' || echo 'N/A')" >> $GITHUB_ENV
          echo "âœ… Tailscale: $TS_IP"

      - name: ðŸ”’ Firewall & Network Optimization
        run: |
          sudo ufw allow 4000/tcp comment "NoMachine NX"
          sudo ufw allow 4022/tcp comment "NoMachine SSH"
          sudo ufw --force enable
          
          # Low latency tuning
          sudo sysctl -w net.core.rmem_max=16777216
          sudo sysctl -w net.core.wmem_max=16777216
          sudo sysctl -w net.ipv4.tcp_rmem="4096 87380 16777216"
          sudo sysctl -w net.ipv4.tcp_wmem="4096 65536 16777216"
          
          echo "âœ… Firewall & network optimized"

      - name: ðŸ“‹ Connection Info
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸ–¥ï¸ LOW-LATENCY UBUNTU XFCE + NoMachine RDP          â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ðŸŒ IP:        $TAILSCALE_IP                        â•‘"
          echo "â•‘  ðŸ”Œ Port:      4000                                 â•‘"
          echo "â•‘  ðŸ‘¤ Username:  runner                               â•‘"
          echo "â•‘  ðŸ”‘ Password:  github2024                           â•‘"
          echo "â•‘  ðŸ·ï¸  MagicDNS: \$MAGIC_DNS                          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“± Download FREE NoMachine Client:"
          echo "   ðŸ”— https://www.nomachine.com/download"
          echo ""
          echo "âš¡ Connect Steps:"
          echo "1. Install NoMachine Client"
          echo "2. New â†’ Host: $TAILSCALE_IP â†’ Port: 4000"
          echo "3. runner / github2024"
          echo "4. WAN Quality â†’ H.264 â†’ 1920x1080 â†’ Connect"
          echo ""
          echo "ðŸŽ¯ Performance: 5-20ms latency, 1080p60 smooth"

      - name: ðŸ©º Health Check & Keep Alive
        run: |
          echo "ðŸš€ Starting monitoring (Ctrl+C to stop)"
          while true; do
            # NoMachine
            if sudo /usr/NX/bin/nxserver --status 2>/dev/null | grep -q "running"; then
              NX_USERS=$(sudo /usr/NX/bin/nxserver --list 2>/dev/null | grep -c "runner" || echo "0")
              NX_STATUS="âœ…"
            else
              sudo /usr/NX/bin/nxserver --startup
              NX_STATUS="ðŸ”„ restarted"
              NX_USERS="0"
            fi
            
            # LightDM
            if systemctl is-active --quiet lightdm; then
              LIGHTDM="âœ…"
            else
              sudo systemctl restart lightdm
              LIGHTDM="ðŸ”„ restarted"
            fi
            
            # Tailscale
            if tailscale status >/dev/null 2>&1; then
              TS_STATUS="âœ…"
            else
              sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
              TS_STATUS="ðŸ”„ reconnected"
            fi
            
            TS_IP=$(tailscale ip -4 2>/dev/null || echo "reconnecting...")
            
            echo "[$(date '+%H:%M:%S')] $NX_STATUS NoMachine($NX_USERS) | $LIGHTDM LightDM | $TS_STATUS Tailscale | IP: $TS_IP"
            
            sleep 60
          done
