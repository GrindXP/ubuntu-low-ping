name: Low-Latency Ubuntu NoMachine RDP

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  nomachine-desktop:
    runs-on: ubuntu-22.04

    steps:
      - name: Install XFCE Desktop
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies xfce4-terminal firefox dbus-x11 \
            lightdm lightdm-gtk-greeter wget curl gnupg \
            net-tools ufw
          echo "âœ… XFCE installed"

      - name: Configure XFCE (Headless Safe)
        run: |
          # Create user config directories for runner
          sudo mkdir -p /home/runner/.config/xfce4/xfconf/xfce-perchannel-xml
          
          # XFCE Desktop (no compositing/shadows)
          sudo tee /home/runner/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml > /dev/null << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <channel name="xfce4-desktop" version="1.0">
            <property name="backdrop" type="array">
              <property name="screen0" type="array">
                <property name="monitor0" type="array">
                  <property name="workspace0" type="string" value="/usr/share/backgrounds/xfce/xfce-flower.png"/>
                  <property name="last-image" type="string" value="/usr/share/backgrounds/xfce/xfce-flower.png"/>
                </property>
              </property>
            </property>
            <property name="show-frame-shadows" type="bool" value="false"/>
            <property name="show-windows-preview" type="bool" value="false"/>
          </channel>
          EOF
          
          # Window Manager (no animations/shadows)
          sudo tee /home/runner/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml > /dev/null << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <channel name="xfwm4" version="1.0">
            <property name="general" type="empty">
              <property name="shadows" type="bool" value="false"/>
              <property name="snap_resist" type="int" value="0"/>
              <property name="show_frame_shadow" type="bool" value="false"/>
            </property>
          </channel>
          EOF
          
          # Theme/Settings
          sudo tee /home/runner/.config/xfce4/xfconf/xfce-perchannel-xml/xsettings.xml > /dev/null << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <channel name="xsettings" version="1.0">
            <property name="Net" type="empty">
              <property name="ThemeName" type="string" value="Greybird"/>
              <property name="IconThemeName" type="string" value="Greybird"/>
              <property name="FontName" type="string" value="Sans 10"/>
            </property>
          </channel>
          EOF
          
          # XFCE Session
          sudo tee /home/runner/.xsession > /dev/null << 'EOF'
          #!/bin/sh
          unset SESSION_MANAGER
          unset DBUS_SESSION_BUS_ADDRESS
          exec /usr/bin/startxfce4
          EOF
          sudo chmod +x /home/runner/.xsession
          
          # Permissions
          sudo chown -R runner:runner /home/runner/.config /home/runner/.xsession
          sudo chmod -R 755 /home/runner/.config
          
          echo "âœ… XFCE configured (headless-safe)"

      - name: Install NoMachine (Best Performance)
        run: |
          cd /tmp
          wget https://download.nomachine.com/download/8.14/Linux/nomachine_8.14.2_1_amd64.deb
          sudo dpkg -i nomachine_8.14.2_1_amd64.deb || sudo apt-get install -f -y
          
          # Max performance config
          sudo sed -i 's/DefaultDesktopCommand ".*"/DefaultDesktopCommand "\/home\/runner\/.xsession"/' /usr/NX/etc/node.cfg
          sudo sed -i 's/EnableSSDVirt=.*/EnableSSDVirt=true/' /usr/NX/etc/node.cfg
          sudo sed -i 's/SessionTimeout=.*/SessionTimeout=7200/' /usr/NX/etc/node.cfg
          sudo sed -i 's/AudioEncoding=.*/AudioEncoding=no/' /usr/NX/etc/node.cfg
          
          # Start services
          sudo systemctl enable lightdm
          sudo systemctl start lightdm
          sudo /usr/NX/bin/nxserver --startup
          
          echo "âœ… NoMachine installed & configured"

      - name: Install & Connect Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${TAILSCALE_AUTH_KEY} --advertise-tags=tag:github-actions
          sleep 5
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "MAGIC_DNS=$(tailscale status | grep runner | awk '{print $1}')" >> $GITHUB_ENV
          echo "âœ… Tailscale: $TS_IP"

      - name: Firewall & Network Optimization
        run: |
          # Open NoMachine ports
          sudo ufw allow 4000/tcp comment "NoMachine NX"
          sudo ufw allow 4022/tcp comment "NoMachine SSH fallback"
          sudo ufw --force enable
          
          # Network tuning for low latency
          sudo sysctl -w net.core.rmem_max=16777216
          sudo sysctl -w net.core.wmem_max=16777216
          sudo sysctl -w net.ipv4.tcp_rmem="4096 87380 16777216"
          sudo sysctl -w net.ipv4.tcp_wmem="4096 65536 16777216"
          
          echo "âœ… Firewall & network optimized"

      - name: Connection Info
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸ–¥ï¸ LOW-LATENCY UBUNTU NoMachine RDP             â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  ðŸŒ IP:        $TAILSCALE_IP                    â•‘"
          echo "â•‘  ðŸ”Œ Port:      4000 (NX Protocol)               â•‘"
          echo "â•‘  ðŸ‘¤ Username:  runner                           â•‘"
          echo "â•‘  ðŸ”‘ Password:  github2024                       â•‘"
          echo "â•‘  ðŸ·ï¸  MagicDNS: \$MAGIC_DNS (if enabled)         â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“± NoMachine Client (FREE): https://www.nomachine.com/download"
          echo ""
          echo "âš¡ Connection Steps:"
          echo "1. Download NoMachine Client"
          echo "2. New â†’ Host: $TAILSCALE_IP â†’ Port: 4000"
          echo "3. User: runner | Pass: github2024"
          echo "4. Quality: WAN | Codec: H.264 | 1920x1080"
          echo ""
          echo "ðŸŽ¯ Expected: 5-20ms latency, smooth 60fps"

      - name: Health Check & Keep Alive
        run: |
          echo "ðŸ©º Starting health monitoring..."
          while true; do
            # NoMachine status
            if sudo /usr/NX/bin/nxserver --status | grep -q "running"; then
              NX_USERS=$(sudo /usr/NX/bin/nxserver --list 2>/dev/null | grep -c "runner")
            else
              sudo /usr/NX/bin/nxserver --startup
              NX_USERS=0
            fi
            
            # LightDM
            systemctl is-active --quiet lightdm || sudo systemctl restart lightdm
            
            # Tailscale
            tailscale status > /dev/null 2>&1 || sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
            
            # Status
            TS_IP=$(tailscale ip -4)
            echo "[$(date '+%H:%M:%S')] âœ… ACTIVE | IP: $TS_IP | NoMachine Users: $NX_USERS | LightDM: $(systemctl is-active lightdm)"
            
            sleep 120
          done
