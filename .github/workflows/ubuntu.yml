name: ðŸš€ Low-Latency Ubuntu NoMachine RDP

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  nomachine-desktop:
    runs-on: ubuntu-22.04

    steps:
      - name: ðŸ“¦ Install XFCE
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies xfce4-terminal firefox dbus-x11 \
            lightdm lightdm-gtk-greeter wget curl gnupg net-tools ufw
          echo "âœ… XFCE installed"

      - name: âš™ï¸ Configure XFCE
        run: |
          sudo mkdir -p /home/runner/.config/xfce4/xfconf/xfce-perchannel-xml
          sudo tee /home/runner/.config/xfce4/xfconf/xfce-perchannel-xml/xfce4-desktop.xml > /dev/null << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <channel name="xfce4-desktop" version="1.0">
            <property name="show-frame-shadows" type="bool" value="false"/>
            <property name="show-windows-preview" type="bool" value="false"/>
          </channel>
          EOF
          sudo tee /home/runner/.xsession > /dev/null << 'EOF'
          #!/bin/sh
          exec startxfce4
          EOF
          sudo chmod +x /home/runner/.xsession
          sudo chown -R runner:runner /home/runner/.config /home/runner/.xsession
          echo "âœ… XFCE configured"

      - name: ðŸ–¥ï¸ Install NoMachine (Fixed)
        run: |
          cd /tmp
          # Direct working URL (verified Feb 2026)
          wget https://download.nomachine.com/download/8.11/Linux/nomachine_8.11.3_4_amd64.deb
          
          # Verify it's real deb
          if file nomachine_8.11.3_4_amd64.deb | grep -q "Debian binary"; then
            sudo dpkg -i nomachine_8.11.3_4_amd64.deb || sudo apt-get install -f -y
          else
            echo "âŒ Download failed, trying mirror"
            wget https://apt.iteas.at/iteas/pool/main/n/nomachine/nomachine_8.11.3_4_amd64.deb
            sudo dpkg -i nomachine_8.11.3_4_amd64.deb || sudo apt-get install -f -y
          fi
          
          # Config (safe)
          [ -f /usr/NX/etc/node.cfg ] && sudo sed -i 's|DefaultDesktopCommand.*|/home/runner/.xsession|' /usr/NX/etc/node.cfg
          
          sudo systemctl enable lightdm
          sudo systemctl start lightdm
          sudo /usr/NX/bin/nxserver --startup
          echo "âœ… NoMachine on port 4000"

      - name: ðŸŒ Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${TAILSCALE_AUTH_KEY}
          sleep 5
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "âœ… Tailscale: $TS_IP"

      - name: ðŸ”’ Firewall
        run: |
          sudo ufw allow 4000/tcp
          sudo ufw --force enable
          echo "âœ… Port 4000 open"

      - name: ðŸ“‹ Connection Info
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸ–¥ï¸ UBUNTU XFCE + NoMachine RDP      â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  IP: $TAILSCALE_IP                   â•‘"
          echo "â•‘  Port: 4000                          â•‘"
          echo "â•‘  User: runner                        â•‘"
          echo "â•‘  Pass: github2024                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“± Client: nomachine.com/download"

      - name: ðŸ©º Keep Alive
        run: |
          while true; do
            sudo /usr/NX/bin/nxserver --status >/dev/null 2>&1 || sudo /usr/NX/bin/nxserver --startup
            systemctl restart lightdm >/dev/null 2>&1
            tailscale status >/dev/null 2>&1 || sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
            echo "[$(date)] âœ… $TAILSCALE_IP | nxserver running"
            sleep 60
          done
