name: ðŸš€ Ubuntu XFCE X2Go RDP (Low Latency - Works 100%)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  x2go-desktop:
    runs-on: ubuntu-22.04

    steps:
      - name: ðŸ“¦ Install XFCE + X2Go
        run: |
          sudo apt-get update
          sudo apt-add-repository ppa:x2go/stable -y
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies xfce4-terminal firefox \
            x2goserver x2goserver-xsession \
            openssh-server net-tools ufw
          echo "âœ… X2Go + XFCE installed"

      - name: ðŸ‘¤ Set Password
        run: |
          echo "runner:github2024" | sudo chpasswd
          echo "âœ… Password set"

      - name: ðŸ” Enable SSH
        run: |
          sudo systemctl enable ssh
          sudo systemctl start ssh
          echo "âœ… SSH running"

      - name: ðŸŒ Tailscale
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${TAILSCALE_AUTH_KEY}
          sleep 5
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV
          echo "âœ… Tailscale: $TS_IP"

      - name: ðŸ”’ Firewall
        run: |
          sudo ufw allow 22/tcp
          sudo ufw allow 4000/tcp
          sudo ufw --force enable
          echo "âœ… Firewall configured"

      - name: ðŸ“‹ Connection Info
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ðŸ–¥ï¸ UBUNTU XFCE + X2Go (5-20ms)      â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          echo "â•‘  IP:   $TAILSCALE_IP                 â•‘"
          echo "â•‘  Port: 22 (SSH for X2Go)             â•‘"
          echo "â•‘  User: runner                        â•‘"
          echo "â•‘  Pass: github2024                    â•‘"
          echo "â•‘  Desktop: XFCE                       â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“± Download X2Go Client (FREE):"
          echo "   Windows: https://wiki.x2go.org/doku.php/download:start"
          echo "   Linux:   sudo apt install x2goclient"
          echo "   Mac:     https://code.x2go.org/releases/X2GoClient_latest_macosx_10_13.dmg"
          echo ""
          echo "âš¡ Connect:"
          echo "   Host: $TAILSCALE_IP"
          echo "   Login: runner"
          echo "   SSH Port: 22"
          echo "   Session: XFCE"

      - name: ðŸ©º Keep Alive
        run: |
          while true; do
            systemctl is-active --quiet ssh || sudo systemctl restart ssh
            tailscale status >/dev/null 2>&1 || sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}
            echo "[$(date '+%H:%M:%S')] âœ… Active | IP: $TAILSCALE_IP | SSH: $(systemctl is-active ssh) | X2Go: Ready"
            sleep 60
          done
